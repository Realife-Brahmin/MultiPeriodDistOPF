\documentclass[11pt]{article}
\usepackage[margin=1in]{geometry}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{mathtools}
\usepackage{xcolor}
\usepackage{booktabs}
\usepackage{array}

% Define colors for variables (matching your PDF formulation)
\definecolor{bluevar}{RGB}{0,100,200}     % Blue for B_t0
\definecolor{redvar}{RGB}{200,0,0}        % Red for B̂
\definecolor{greenvar}{RGB}{0,128,0}      % Darker green for u_t0 (matching battery charging color)

\newcommand{\blueB}[1]{\textcolor{bluevar}{\mathbf{#1}}}      % Blue B_t0
\newcommand{\redBhat}[1]{\textcolor{redvar}{\mathbf{#1}}}     % Red B̂
\newcommand{\greenu}[1]{\textcolor{greenvar}{\mathbf{#1}}}    % Green u_t0

\title{Multi-Period Optimal Power Flow:\\LinDistFlow \& Copper Plate tADMM Formulations}
\author{}
\date{}
% \date{\today}

\begin{document}
\maketitle

\section{NEW: Local Neighbor Coupling tADMM (Reduced Communication)}

\subsection{Overview}

This formulation modifies the standard tADMM algorithm to use \textbf{local temporal coupling} instead of global coupling. Each subproblem $t_0$ only shares SOC variables with its immediate time neighbors $(t_0-1, t_0, t_0+1)$, reducing coupling from $\mathcal{O}(T \times |\mathcal{B}|)$ to $\mathcal{O}(3 \times |\mathcal{B}|)$ per subproblem.

\subsection{Key Modifications}

\begin{itemize}
    \item \textbf{Original (Global Coupling)}: Each subproblem $t_0$ couples with \textit{all} $T$ time steps
    \item \textbf{New (Local Coupling)}: Each subproblem $t_0$ couples only with neighbors $\{t_0-1, t_0, t_0+1\}$
    \item \textbf{Memory Reduction}: $T^2 \times |\mathcal{B}| \to 3T \times |\mathcal{B}|$ total storage
    \item \textbf{Communication Reduction}: Each subproblem exchanges $3 \times |\mathcal{B}|$ variables (not $T \times |\mathcal{B}|$)
\end{itemize}

\subsection{Local Time Sets}

For each subproblem $t_0 \in \{1, 2, \ldots, T\}$, define the local time set:
\begin{align}
\mathcal{T}_{\text{local}}^{t_0} = \begin{cases}
\{1, 2\} & \text{if } t_0 = 1 \text{ (boundary)} \\
\{t_0-1, t_0, t_0+1\} & \text{if } 2 \leq t_0 \leq T-1 \text{ (interior)} \\
\{T-1, T\} & \text{if } t_0 = T \text{ (boundary)}
\end{cases}
\end{align}

\subsection{Step 1: Primal Update (Local Coupling)}

For each subproblem $t_0 \in \{1, 2, \ldots, T\}$:

\begin{align}
\min_{\substack{P_{\text{Subs}}^{t_0}, Q_{\text{Subs}}^{t_0}, \\ P_{ij}^{t_0}, Q_{ij}^{t_0}, v_j^{t_0}, q_{D,j}^{t_0}, \\ P_{B,j}^t, \blueB{B_j^{t_0}[t]} \\ \forall j \in \mathcal{B}, \, t \in \mathcal{T}_{\text{local}}^{t_0}}} \quad & c^{t_0} \cdot P_{\text{Subs}}^{t_0} \cdot P_{\text{BASE}} \cdot \Delta t + C_B \sum_{j \in \mathcal{B}} \left(P_{B,j}^{t_0}\right)^2 \cdot P_{\text{BASE}}^2 \cdot \Delta t \notag \\
& + \frac{\rho}{2} \sum_{j \in \mathcal{B}} \sum_{t \in \mathcal{T}_{\text{local}}^{t_0}} \left( \blueB{B_j^{t_0}[t]} - \redBhat{\hat{B}_j[t]} + \greenu{u_j^{t_0}[t]} \right)^2
\end{align}

\textbf{Subject to:}

\textbf{Spatial Network Constraints (only for time $t_0$):}
\begin{align}
\text{(Same as global formulation - constraints (2)-(8))}
\end{align}

\textbf{Temporal Battery Constraints:}

\noindent\textbf{Case 1: First time period ($t_0 = 1$):}

\textit{Local times: $\{1, 2\}$, Decision variables: $\blueB{B_j^{1}[1]}, \blueB{B_j^{1}[2]}$, Dual variables: $\greenu{u_j^{1}[1]}$ only}
\begin{align}
\text{SOC trajectory } t=0 \to t=1: \quad & \blueB{B_j^{1}[1]} = B_{0,j} - P_{B,j}^1 \cdot \Delta t, \quad \forall j \in \mathcal{B} \\
\text{SOC trajectory } t=1 \to t=2: \quad & \blueB{B_j^{1}[2]} = \blueB{B_j^{1}[1]} - P_{B,j}^2 \cdot \Delta t, \quad \forall j \in \mathcal{B}
\end{align}

\textit{Note:} $B_{0,j}$ is a parameter (initial condition), not a decision variable. Only $\blueB{B_j^{1}[1]}$ participates in consensus (with dual $\greenu{u_j^{1}[1]}$). Variable $\blueB{B_j^{1}[2]}$ exists for penalty computation but does not participate in consensus at $t=1$.

\noindent\textbf{Case 2: Interior time periods ($2 \leq t_0 \leq T-1$):}

\textit{Local times: $\{t_0-1, t_0, t_0+1\}$, Decision variables: $\blueB{B_j^{t_0}[t_0-1]}, \blueB{B_j^{t_0}[t_0]}, \blueB{B_j^{t_0}[t_0+1]}$}

\textit{Dual variables: $\greenu{u_j^{t_0}[t_0]}$ only}
\begin{align}
\text{SOC trajectory } t_0-1 \to t_0: \quad & \blueB{B_j^{t_0}[t_0]} = \blueB{B_j^{t_0}[t_0-1]} - P_{B,j}^{t_0} \cdot \Delta t, \quad \forall j \in \mathcal{B} \\
\text{SOC trajectory } t_0 \to t_0+1: \quad & \blueB{B_j^{t_0}[t_0+1]} = \blueB{B_j^{t_0}[t_0]} - P_{B,j}^{t_0+1} \cdot \Delta t, \quad \forall j \in \mathcal{B}
\end{align}

\textit{Note:} Only $\blueB{B_j^{t_0}[t_0]}$ participates in consensus update at time $t_0$ (with dual $\greenu{u_j^{t_0}[t_0]}$). Variables $\blueB{B_j^{t_0}[t_0-1]}$ and $\blueB{B_j^{t_0}[t_0+1]}$ are used for penalty terms but do not generate new dual variables in this subproblem.

\noindent\textbf{Case 3: Last time period ($t_0 = T$):}

\textit{Local times: $\{T-1, T\}$, Decision variables: $\blueB{B_j^{T}[T-1]}, \blueB{B_j^{T}[T]}$, Dual variables: $\greenu{u_j^{T}[T]}$ only}
\begin{align}
\text{SOC trajectory } T-1 \to T: \quad & \blueB{B_j^{T}[T]} = \blueB{B_j^{T}[T-1]} - P_{B,j}^T \cdot \Delta t, \quad \forall j \in \mathcal{B}
\end{align}

\textit{Note:} Only $\blueB{B_j^{T}[T]}$ participates in consensus at $t=T$ (with dual $\greenu{u_j^{T}[T]}$). Variable $\blueB{B_j^{T}[T-1]}$ is for penalty only.

\textbf{SOC and Power Limits:}
\begin{align}
\text{SOC limits:} \quad & \text{SOC}_{\min,j} \cdot B_{\text{rated},j} \leq \blueB{B_j^{t_0}[t]} \leq \text{SOC}_{\max,j} \cdot B_{\text{rated},j}, \notag \\
& \quad \forall t \in \mathcal{T}_{\text{local}}^{t_0}, \, j \in \mathcal{B} \\
\text{Power limits:} \quad & -P_{B,\text{rated},j} \leq P_{B,j}^{t} \leq P_{B,\text{rated},j}, \quad \forall t \in \mathcal{T}_{\text{local}}^{t_0}, \, j \in \mathcal{B}
\end{align}

\textit{Note:} Power limits must be enforced for \textit{all} times appearing in constraints, not just $t_0$. For interior times: $P_{B,j}^{t_0-1}, P_{B,j}^{t_0}, P_{B,j}^{t_0+1}$ all need limits.

\subsection{Step 2: Consensus Update (Local Averaging)}

For each battery $j \in \mathcal{B}$ and each time $t \in \mathcal{T}$, average only over subproblems where $t$ is the \textit{active} time:

\noindent\textbf{Consensus at $t=1$:}
\begin{align}
\redBhat{\hat{B}_j[1]} &= \text{clamp}\left( \frac{1}{2} \left( \blueB{B_j^{1}[1]} + \greenu{u_j^{1}[1]} + \blueB{B_j^{2}[1]} + \greenu{u_j^{2}[1]} \right), \underline{B}_j, \overline{B}_j \right)
\end{align}
\textit{Contributors:} Subproblems $t_0=1$ and $t_0=2$ (only these have $t=1$ as decision variable with dual)

\noindent\textbf{Consensus at interior times ($2 \leq t \leq T-1$):}
\begin{align}
\redBhat{\hat{B}_j[t]} &= \text{clamp}\left( \frac{1}{3} \left( \blueB{B_j^{t-1}[t]} + \greenu{u_j^{t-1}[t]} + \blueB{B_j^{t}[t]} + \greenu{u_j^{t}[t]} + \blueB{B_j^{t+1}[t]} + \greenu{u_j^{t+1}[t]} \right), \underline{B}_j, \overline{B}_j \right)
\end{align}
\textit{Contributors:} Subproblems $t_0 \in \{t-1, t, t+1\}$ (each has $t$ as its active control time)

\noindent\textbf{Consensus at $t=T$:}
\begin{align}
\redBhat{\hat{B}_j[T]} &= \text{clamp}\left( \frac{1}{2} \left( \blueB{B_j^{T-1}[T]} + \greenu{u_j^{T-1}[T]} + \blueB{B_j^{T}[T]} + \greenu{u_j^{T}[T]} \right), \underline{B}_j, \overline{B}_j \right)
\end{align}
\textit{Contributors:} Subproblems $t_0=T-1$ and $t_0=T$ (only these have $t=T$ as decision variable with dual)

\textbf{General form:}
\begin{align}
\mathcal{N}_t &= \{t_0 \in \mathcal{T} : t \text{ is the active control time in subproblem } t_0\} \\
&= \begin{cases}
\{1, 2\} & \text{if } t = 1 \\
\{t-1, t, t+1\} & \text{if } 2 \leq t \leq T-1 \\
\{T-1, T\} & \text{if } t = T
\end{cases}
\end{align}

\subsection{Step 3: Dual Update (Active Time Only)}

For each subproblem $t_0 \in \mathcal{T}$ and battery $j \in \mathcal{B}$, update dual \textit{only} for the active control time $t_0$:

\noindent\textbf{Subproblem $t_0=1$:}
\begin{align}
\greenu{u_j^{1}[1]} &:= \greenu{u_j^{1}[1]} + \left( \blueB{B_j^{1}[1]} - \redBhat{\hat{B}_j[1]} \right)
\end{align}

\noindent\textbf{Subproblem $t_0$ ($2 \leq t_0 \leq T-1$):}
\begin{align}
\greenu{u_j^{t_0}[t_0]} &:= \greenu{u_j^{t_0}[t_0]} + \left( \blueB{B_j^{t_0}[t_0]} - \redBhat{\hat{B}_j[t_0]} \right)
\end{align}

\noindent\textbf{Subproblem $t_0=T$:}
\begin{align}
\greenu{u_j^{T}[T]} &:= \greenu{u_j^{T}[T]} + \left( \blueB{B_j^{T}[T]} - \redBhat{\hat{B}_j[T]} \right)
\end{align}

\textbf{Critical Note:} Each subproblem $t_0$ maintains \textit{only one} dual variable per battery: $\greenu{u_j^{t_0}[t_0]}$. 

\noindent The local SOC variables $\blueB{B_j^{t_0}[t_0 \pm 1]}$ are used in penalty terms for coupling but do \textit{not} generate separate dual updates within subproblem $t_0$. They will be updated when those times are the active control time in their respective subproblems.

\subsection{Convergence Criteria}

\textbf{Primal Residual (only for coupled times):}
\begin{align}
\|r^k\|_2 &= \frac{1}{\sqrt{N_{\text{coupled}}}} \left( \sum_{t_0 \in \mathcal{T}} \sum_{j \in \mathcal{B}} \sum_{t \in \mathcal{T}_{\text{local}}^{t_0}} \left( \blueB{B_j^{t_0}[t]} - \redBhat{\hat{B}_j[t]} \right)^2 \right)^{1/2}
\end{align}

where $N_{\text{coupled}} = \sum_{t_0 \in \mathcal{T}} |\mathcal{T}_{\text{local}}^{t_0}| \times |\mathcal{B}| = (2 + 3(T-2) + 2) \times |\mathcal{B}| = 3T \times |\mathcal{B}| - 2|\mathcal{B}|$.

\textbf{Dual Residual:}
\begin{align}
\|s^k\|_2 &= \frac{\rho}{|\mathcal{B}|} \sqrt{\sum_{j \in \mathcal{B}} \sum_{t=1}^T \left( \redBhat{\hat{B}_j^k[t]} - \redBhat{\hat{B}_j^{k-1}[t]} \right)^2} \leq \epsilon_{\text{dual}}
\end{align}

\subsection{Complexity Comparison}

\begin{center}
\begin{tabular}{lcc}
\toprule
\textbf{Metric} & \textbf{Global Coupling} & \textbf{Local Coupling} \\
\midrule
SOC variables per subproblem & $T \times |\mathcal{B}|$ & $2$ or $3 \times |\mathcal{B}|$ \\
Dual variables per subproblem & $T \times |\mathcal{B}|$ & $1 \times |\mathcal{B}|$ \\
Penalty terms per subproblem & $T \times |\mathcal{B}|$ & $2$ or $3 \times |\mathcal{B}|$ \\
Total SOC storage & $T^2 \times |\mathcal{B}|$ & $(2 \cdot 2 + 3 \cdot (T-2)) \times |\mathcal{B}| = (3T-2) \times |\mathcal{B}|$ \\
Total dual storage & $T^2 \times |\mathcal{B}|$ & $T \times |\mathcal{B}|$ \\
Communication per iteration & $T \times |\mathcal{B}|$ per subproblem & $2$ or $3 \times |\mathcal{B}|$ per subproblem \\
Consensus contributors & All $T$ subproblems & Only $2$ or $3$ neighbors \\
\bottomrule
\end{tabular}
\end{center}

\textbf{For $T=24$, $|\mathcal{B}|=26$ batteries:}
\begin{itemize}
    \item \textbf{SOC Variables:}
    \begin{itemize}
        \item Global: $24^2 \times 26 = 14,976$ total
        \item Local: $(3 \times 24 - 2) \times 26 = 1,872$ total
        \item \textbf{Reduction: $8.0\times$}
    \end{itemize}
    \item \textbf{Dual Variables:}
    \begin{itemize}
        \item Global: $24^2 \times 26 = 14,976$ total
        \item Local: $24 \times 26 = 624$ total
        \item \textbf{Reduction: $24\times$}
    \end{itemize}
    \item \textbf{Per-subproblem SOC variables:}
    \begin{itemize}
        \item Global: $24 \times 26 = 624$ per subproblem
        \item Local (boundary): $2 \times 26 = 52$ per subproblem
        \item Local (interior): $3 \times 26 = 78$ per subproblem
        \item \textbf{Reduction: $12\times$ (boundary), $8\times$ (interior)}
    \end{itemize}
\end{itemize}

\newpage

\section{LinDistFlow MPOPF with tADMM}

\subsection{Problem Overview}

The Temporal ADMM (tADMM) algorithm decomposes the multi-period optimal power flow problem for distribution networks into $T$ subproblems, each corresponding to one time period. This formulation uses the linearized DistFlow model to capture network physics including voltage drops and reactive power flows.

\subsection{Variable Color Coding}
\begin{itemize}
    \item $\blueB{B_j^{t_0}[t]}$: Local SOC variables for battery $j$ in subproblem $t_0$, evaluated at time $t$ (blue)
    \item $\redBhat{\hat{B}_j[t]}$: Global consensus SOC for battery $j$ at time $t$ (red)
    \item $\greenu{u_j^{t_0}[t]}$: Local scaled dual variables for battery $j$ in subproblem $t_0$, for time $t$ (green)
\end{itemize}

\subsection{Sets and Indices}
\begin{itemize}
    \item $\mathcal{N}$: Set of all nodes (buses)
    \item $\mathcal{L}$: Set of all branches (lines)
    \item $\mathcal{L}_1$: Set of branches connected to substation (node 1)
    \item $\mathcal{B}$: Set of nodes with batteries
    \item $\mathcal{D}$: Set of nodes with PV (DER)
    \item $\mathcal{T} = \{1, 2, \ldots, T\}$: Set of time periods
    \item $t_0 \in \mathcal{T}$: Index for a specific time period in tADMM decomposition
    \item $j \in \mathcal{N}$: Node index
    \item $(i,j) \in \mathcal{L}$: Branch from node $i$ to node $j$
\end{itemize}

\subsection{tADMM Algorithm Structure}

The algorithm alternates between three update steps:

\subsection{Step 1: Subproblem Update (Blue Variables)}
For each subproblem $t_0 \in \{1, 2, \ldots, T\}$:

\begin{align}
\min_{\substack{P_{\text{Subs}}^{t_0}, Q_{\text{Subs}}^{t_0}, \\ P_{ij}^{t_0}, Q_{ij}^{t_0}, v_j^{t_0}, q_{D,j}^{t_0}, \\ P_{B,j}^t, \blueB{B_j^{t_0}[t]} \\ \forall j \in \mathcal{B}, \, t \in \mathcal{T}}} \quad & c^{t_0} \cdot P_{\text{Subs}}^{t_0} \cdot P_{\text{BASE}} \cdot \Delta t + C_B \sum_{j \in \mathcal{B}} \left(P_{B,j}^{t_0}\right)^2 \cdot P_{\text{BASE}}^2 \cdot \Delta t \notag \\
& + \frac{\rho}{2} \sum_{j \in \mathcal{B}} \sum_{t=1}^T \left( \blueB{B_j^{t_0}[t]} - \redBhat{\hat{B}_j[t]} + \greenu{u_j^{t_0}[t]} \right)^2
\end{align}

\textbf{Subject to:}

\textbf{Spatial Network Constraints (only for time $t_0$):}
\begin{align}
\text{Real power balance (substation):} \quad & P_{\text{Subs}}^{t_0} - \sum_{(1,j) \in \mathcal{L}_1} P_{1j}^{t_0} = 0 \\
\text{Real power balance (nodes):} \quad & P_{ij}^{t_0} - \sum_{(j,k) \in \mathcal{L}} P_{jk}^{t_0} = P_{B,j}^{t_0} + p_{D,j}^{t_0} - p_{L,j}^{t_0}, \notag \\
& \quad \forall (i,j) \in \mathcal{L}, \\
\text{Reactive power balance (substation):} \quad & Q_{\text{Subs}}^{t_0} - \sum_{(1,j) \in \mathcal{L}_1} Q_{1j}^{t_0} = 0 \\
\text{Reactive power balance (nodes):} \quad & Q_{ij}^{t_0} - \sum_{(j,k) \in \mathcal{L}} Q_{jk}^{t_0} = q_{D,j}^{t_0} - q_{L,j}^{t_0}, \notag \\
& \quad \forall (i,j) \in \mathcal{L}, \\
\text{KVL constraints:} \quad & v_i^{t_0} - v_j^{t_0} = 2(r_{ij} P_{ij}^{t_0} + x_{ij} Q_{ij}^{t_0}), \quad \forall (i,j) \in \mathcal{L} \\
\text{Voltage limits:} \quad & (V_{\min,j})^2 \leq v_j^{t_0} \leq (V_{\max,j})^2, \quad \forall j \in \mathcal{N} \\
\text{PV reactive limits:} \quad & -\sqrt{(S_{D,j})^2 - (p_{D,j}^{t_0})^2} \leq q_{D,j}^{t_0} \leq \sqrt{(S_{D,j})^2 - (p_{D,j}^{t_0})^2}, \notag \\
& \quad \forall j \in \mathcal{D}
\end{align}

\textbf{Temporal Battery Constraints (entire horizon $t \in \{1, \ldots, T\}$):}
\begin{align}
\text{Initial SOC:} \quad & \blueB{B_j^{t_0}[1]} = B_{0,j} - P_{B,j}^1 \cdot \Delta t, \quad \forall j \in \mathcal{B} \\
\text{SOC trajectory:} \quad & \blueB{B_j^{t_0}[t]} = \blueB{B_j^{t_0}[t-1]} - P_{B,j}^t \cdot \Delta t, \quad \forall t \in \{2, \ldots, T\}, \, j \in \mathcal{B} \\
\text{SOC limits:} \quad & \text{SOC}_{\min,j} \cdot B_{\text{rated},j} \leq \blueB{B_j^{t_0}[t]} \leq \text{SOC}_{\max,j} \cdot B_{\text{rated},j}, \notag \\
& \quad \forall t \in \mathcal{T}, \, j \in \mathcal{B} \\
\text{Power limits:} \quad & -P_{B,\text{rated},j} \leq P_{B,j}^t \leq P_{B,\text{rated},j}, \quad \forall t \in \mathcal{T}, \, j \in \mathcal{B}
\end{align}

\textbf{Key Formulation Notes:}
\begin{itemize}
    \item \textbf{Network variables} $(P_{\text{Subs}}^{t_0}, Q_{\text{Subs}}^{t_0}, P_{ij}^{t_0}, Q_{ij}^{t_0}, v_j^{t_0}, q_{D,j}^{t_0})$ are optimized \textit{only} for time step $t_0$
    \item \textbf{Battery power} $P_{B,j}^t$ is optimized for the \textit{entire} horizon $t \in \{1, \ldots, T\}$
    \item \textbf{Local SOC trajectory} $\blueB{B_j^{t_0}[t]}$ (blue) is computed for \textit{all} time steps $t \in \{1, \ldots, T\}$
    \item The ADMM consensus penalty compares the full local trajectory $\blueB{B_j^{t_0}[t]}$ with the global master copy $\redBhat{\hat{B}_j[t]}$ (red)
    \item Each battery $j \in \mathcal{B}$ has its own local/global SOC variables and dual variables
\end{itemize}

\subsection{Step 2: Consensus Update (Red Variables)}
For each battery $j \in \mathcal{B}$ and each time period $t \in \mathcal{T}$:
\begin{align}
\redBhat{\hat{B}_j[t]} &= \text{clamp}\left( \frac{1}{T} \sum_{t_0=1}^{T} \left( \blueB{B_j^{t_0}[t]} + \greenu{u_j^{t_0}[t]} \right), \underline{B}_j, \overline{B}_j \right)
\end{align}

where $\underline{B}_j = \text{SOC}_{\min,j} \cdot B_{\text{rated},j}$ and $\overline{B}_j = \text{SOC}_{\max,j} \cdot B_{\text{rated},j}$.

\subsection{Step 3: Dual Update (Green Variables)}
For each battery $j \in \mathcal{B}$, each subproblem $t_0 \in \mathcal{T}$, and each time period $t \in \mathcal{T}$:
\begin{align}
\greenu{u_j^{t_0}[t]} &:= \greenu{u_j^{t_0}[t]} + \left( \blueB{B_j^{t_0}[t]} - \redBhat{\hat{B}_j[t]} \right)
\end{align}

\subsection{Convergence Criteria}

\textbf{Primal Residual (Consensus Violation):}
\begin{align}
\|r^k\|_2 &= \frac{1}{|\mathcal{B}|} \sqrt{\sum_{j \in \mathcal{B}} \sum_{t=1}^T \left( \frac{1}{T} \sum_{t_0=1}^T \blueB{B_j^{t_0}[t]} - \redBhat{\hat{B}_j[t]} \right)^2} \leq \epsilon_{\text{pri}}
\end{align}

\textbf{Dual Residual (Consensus Change):}
\begin{align}
\|s^k\|_2 &= \frac{\rho}{|\mathcal{B}|} \sqrt{\sum_{j \in \mathcal{B}} \sum_{t=1}^T \left( \redBhat{\hat{B}_j^k[t]} - \redBhat{\hat{B}_j^{k-1}[t]} \right)^2} \leq \epsilon_{\text{dual}}
\end{align}

\newpage

\section{Copper Plate MPOPF with tADMM (Simplified Case)}

\subsection{Problem Overview}

The Temporal ADMM (tADMM) algorithm decomposes the multi-period optimal power flow problem into $T$ single-step subproblems, each corresponding to one time period. The hope is to enable parallel computation and improved scalability while still retaining solution optimality.

\subsection{Variable Color Coding}
Following the handwritten PDF formulation:
\begin{itemize}
    \item $\blueB{B^{t_0}}$: Local SOC variables for subproblem $t_0$ (blue)
    \item $\redBhat{\hat{B}}$: Global consensus SOC trajectory (red)
    \item $\greenu{u^{t_0}}$: Local scaled dual variables for subproblem $t_0$ (green)
\end{itemize}

\subsection{tADMM Algorithm Structure}

The algorithm alternates between three update steps:

\subsection{Step 1: Primal Update (Blue Variables) tADMM Optimization Model}
For each subproblem $t_0 \in \{1, 2, \ldots, T\}$:

\begin{align}
\min_{P_{\text{subs}}^{t_0}, P_{B}^{t_0}, \blueB{B^{t_0}}} \quad & C^{t_0} \cdot P_{\text{subs}}^{t_0} + C_B \cdot \left(P_{B}^{t_0}\right)^2 + \frac{\rho}{2} \left\| \blueB{B^{t_0}} - \redBhat{\hat{B}} + \greenu{u^{t_0}} \right\|_2^2
\end{align}

\textbf{Subject to SOC Dynamics for Entire Trajectory:}
\begin{align}
\blueB{B^{t_0}[1]} &= B_0 - P_{B}^{t_0} \cdot \Delta t \\
\blueB{B^{t_0}[t]} &= \blueB{B^{t_0}[t-1]} - P_{B}^{t_0} \cdot \Delta t, \quad \forall t \in \{2, \ldots, T\} \\
P_{\text{subs}}^{t_0} + P_{B}^{t_0} &= P_L[t_0] \\
-P_{B,R} \leq P_{B}^{t_0} &\leq P_{B,R} \\
\underline{B} \leq \blueB{B^{t_0}[t]} &\leq \overline{B}, \quad \forall t \in \{1, \ldots, T\}
\end{align}

% Original pedantic inequality constraints (commented out):
% -P_{B,R} - P_{B,t_0} \leq 0
% P_{B,t_0} - P_{B,R} \leq 0 
% \text{SOC}_{\min} \cdot E_{\text{Rated}} - \blueB{B^{t_0}[t]} \leq 0, \forall t \in \{1, \ldots, T\}
% \blueB{B^{t_0}[t]} - \text{SOC}_{\max} \cdot E_{\text{Rated}} \leq 0, \forall t \in \{1, \ldots, T\}

\textbf{Key Formulation Notes:}
\begin{itemize}
    \item Each subproblem $t_0$ optimizes the battery power $P_{B}^{t_0}$ for \textit{only} time step $t_0$
    \item However, the SOC trajectory $\blueB{B^{t_0}[t]}$ is computed for \textit{all} time steps $t \in \{1, \ldots, T\}$
    \item This ensures that the ADMM penalty term can compare the full trajectory $\blueB{B^{t_0}}$ with the consensus $\redBhat{\hat{B}}$
    \item The power balance constraint is enforced only for the specific time $t_0$
\end{itemize}

\subsection{Step 2: Consensus Update (Red Variables)}
\begin{align}
\redBhat{\hat{B}[t]} &= \text{clamp}\left( \frac{1}{T} \sum_{t_0=1}^{T} \left( \blueB{B^{t_0}[t]} + \greenu{u^{t_0}[t]} \right), \underline{B}, \overline{B} \right) \\
&\quad \forall t \in \{1, 2, \ldots, T-1\} \\
\redBhat{\hat{B}[T]} &= B_{T,\text{target}} \quad \text{(if terminal constraint exists)}
\end{align}

\subsection{Step 3: Dual Update (Green Variables)}
\begin{align}
\greenu{u^{t_0}[t]} &:= \greenu{u^{t_0}[t]} + \left( \blueB{B^{t_0}[t]} - \redBhat{\hat{B}[t]} \right) \\
&\quad \forall t_0 \in \{1, \ldots, T\}, \, \forall t \in \{1, \ldots, T\}
\end{align}

\section{Convergence Criteria}

The algorithm terminates when both residuals fall below specified thresholds:

\subsection{Primal Residual (Consensus Violation)}
\begin{align}
\|r^k\|_2 &= \left\| \text{vec}\left( \left\{ \blueB{B^{t_0}} - \redBhat{\hat{B}} \right\}_{t_0=1}^T \right) \right\|_2 \leq \epsilon_{\text{pri}}
\end{align}

\subsection{Dual Residual (Consensus Change)}
\begin{align}
\|s^k\|_2 &= \rho \left\| \redBhat{\hat{B}^k} - \redBhat{\hat{B}^{k-1}} \right\|_2 \leq \epsilon_{\text{dual}}
\end{align}

\section{Algorithm Parameters}

\subsection{Objective Function Components}

The tADMM objective function for each subproblem $t_0$ consists of three terms:

\begin{align}
\text{Energy Cost:} \quad & C^{t_0} \cdot P_{\text{subs}}^{t_0} \cdot \Delta t \\
\text{Battery Quadratic Cost:} \quad & C_B \cdot \left(P_{B}^{t_0}\right)^2 \cdot \Delta t \\
\text{ADMM Penalty:} \quad & \frac{\rho}{2} \left\| \blueB{B^{t_0}} - \redBhat{\hat{B}} + \greenu{u^{t_0}} \right\|_2^2
\end{align}

Where:
\begin{itemize}
    \item $C^{t_0}$: Energy price at time $t_0$ [\$/kWh]
    \item $C_B$: Battery quadratic cost coefficient [\$/kW$^2$/h] (typically $10^{-6} \times \min(C^t)$)
    \item $\rho$: ADMM penalty parameter (adaptive or fixed)
\end{itemize}

The battery quadratic cost term $C_B \cdot \left(P_{B}^{t_0}\right)^2$ serves as a regularization to:
\begin{enumerate}
    \item Prevent excessive battery cycling
    \item Encourage smoother power trajectories
    \item Improve numerical conditioning of the optimization problem
\end{enumerate}

\subsection{Algorithmic Parameters}

\begin{itemize}
    \item \textbf{Penalty Parameter}: $\rho_{\text{init}} = 10.0$ (initial value if adaptive)
    \item \textbf{Primal Tolerance}: $\epsilon_{\text{pri}} = 10^{-5}$
    \item \textbf{Dual Tolerance}: $\epsilon_{\text{dual}} = 10^{-4}$
    \item \textbf{Maximum Iterations}: 1000
\end{itemize}

\subsection{Adaptive Penalty Parameter (Boyd et al. 2011)}

The penalty parameter $\rho$ can be adjusted dynamically to balance convergence rates of primal and dual residuals. The adaptive scheme is activated by setting \texttt{adaptive\_rho = true}.

\textbf{Residual Balance Criterion:}

At iteration $k$, if the residuals are imbalanced by more than factor $\mu$:
\begin{align}
\text{If } \|r^k\|_2 &> \mu \cdot \|s^k\|_2: \quad \text{Primal residual too large} \\
\text{If } \|s^k\|_2 &> \mu \cdot \|r^k\|_2: \quad \text{Dual residual too large}
\end{align}

\textbf{Penalty Parameter Update (every $N_{\text{update}}$ iterations):}
\begin{align}
\rho^{k+1} &= \begin{cases}
\min(\rho_{\max}, \tau_{\text{incr}} \cdot \rho^k) & \text{if } \|r^k\|_2 > \mu \cdot \|s^k\|_2 \\
\max(\rho_{\min}, \rho^k / \tau_{\text{decr}}) & \text{if } \|s^k\|_2 > \mu \cdot \|r^k\|_2 \\
\rho^k & \text{otherwise (residuals balanced)}
\end{cases}
\end{align}

\textbf{Dual Variable Rescaling:}

When $\rho$ changes from $\rho^k$ to $\rho^{k+1}$, the scaled dual variables must be rescaled:
\begin{align}
\greenu{u^{t_0}[t]} &\leftarrow \greenu{u^{t_0}[t]} \cdot \frac{\rho^{k+1}}{\rho^k}, \quad \forall t_0, t
\end{align}

This maintains the relationship between scaled and unscaled dual variables: $\greenu{u} = \lambda / \rho$.

\textbf{Adaptive Parameters:}
\begin{itemize}
    \item \textbf{Balance factor}: $\mu = 10.0$ (higher for copper plate vs. $5.0$ for SOCP)
    \item \textbf{Increase factor}: $\tau_{\text{incr}} = 2.0$
    \item \textbf{Decrease factor}: $\tau_{\text{decr}} = 2.0$
    \item \textbf{Bounds}: $\rho_{\min} = 0.1$, $\rho_{\max} = 10^6$
    \item \textbf{Update interval}: $N_{\text{update}} = 10$ iterations
\end{itemize}

\textbf{Convergence Impact:}

For the copper plate problem (24-hour horizon, 1000 kVA base):
\begin{itemize}
    \item \textbf{Fixed $\rho = 10.0$}: Converges in $\sim$200--400 iterations
    \item \textbf{Adaptive $\rho$}: Converges in $\sim$98 iterations (2--4$\times$ speedup)
    \item Typical $\rho$ trajectory: $10.0 \to 5.0 \to 2.5 \to 1.25$ (decreasing to balance residuals)
\end{itemize}

\section{Appendix: Full Variable and Parameter Definitions}

\subsection{System Bases}
\begin{align}
\text{kV}_B &= \frac{4.16}{\sqrt{3}} \text{ kV (phase-to-neutral)} \\
\text{kVA}_B &= 1000 \text{ kVA} \\
P_{\text{BASE}} &= 1000 \text{ kW} \\
E_{\text{BASE}} &= 1000 \text{ kWh per hour}
\end{align}

\subsection{SOC Bound Definitions}
\begin{align}
\underline{B} &= \text{SOC}_{\min} \cdot E_{\text{Rated}} \\
\overline{B} &= \text{SOC}_{\max} \cdot E_{\text{Rated}}
\end{align}

\subsection{Physical Interpretation}
\begin{itemize}
    \item $P_B[t] > 0$: Battery discharging (providing power to the system)
    \item $P_B[t] < 0$: Battery charging (consuming power from the system)
    \item $B[t]$: Battery state of charge at the end of period $t$
    \item $\underline{B} = \text{SOC}_{\min} \cdot E_{\text{Rated}}$: Lower SOC bound
    \item $\overline{B} = \text{SOC}_{\max} \cdot E_{\text{Rated}}$: Upper SOC bound
\end{itemize}

\end{document}