\documentclass[11pt]{article}
\usepackage[margin=1in]{geometry}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{mathtools}
\usepackage{xcolor}
\usepackage{booktabs}
\usepackage{array}

% Define colors for variables (matching your PDF formulation)
\definecolor{bluevar}{RGB}{0,100,200}     % Blue for B_t0
\definecolor{redvar}{RGB}{200,0,0}        % Red for B̂
\definecolor{greenvar}{RGB}{0,128,0}      % Darker green for u_t0 (matching battery charging color)

\newcommand{\blueB}[1]{\textcolor{bluevar}{\mathbf{#1}}}      % Blue B_t0
\newcommand{\redBhat}[1]{\textcolor{redvar}{\mathbf{#1}}}     % Red B̂
\newcommand{\greenu}[1]{\textcolor{greenvar}{\mathbf{#1}}}    % Green u_t0

\title{Multi-Period Optimal Power Flow with tADMM:\\Temporally Localized ADMM for LinDistFlow SOCP}
\author{}
\date{}
% \date{\today}

\begin{document}
\maketitle

\tableofcontents
\clearpage

\section{tADMM for LinDistFlow SOCP}

\subsection{Overview}

The Temporal ADMM (tADMM) algorithm decomposes the multi-period optimal power flow problem into $T$ subproblems, one for each time period. This formulation uses \textbf{localized temporal coupling} where each subproblem $t_0$ only couples with its immediate time neighbors $(t_0-1, t_0, t_0+1)$, rather than coupling with all $T$ time steps.

\textbf{Key Benefits:}
\begin{itemize}
    \item \textbf{Reduced Coupling}: Each subproblem exchanges $2$--$3 \times |\mathcal{B}|$ variables (not $T \times |\mathcal{B}|$)
    \item \textbf{Memory Efficiency}: $(3T-2) \times |\mathcal{B}|$ total storage vs. $T^2 \times |\mathcal{B}|$ for global coupling
    \item \textbf{Parallel Computation}: All $T$ subproblems can be solved in parallel
    \item \textbf{Network Physics}: Captures voltage drops, reactive power, and SOC constraints via LinDistFlow SOCP
\end{itemize}

\subsection{Problem Definition}

\textbf{Sets and Indices:}
\begin{itemize}
    \item $\mathcal{N}$: Set of all nodes (buses) in the distribution network
    \item $\mathcal{L}$: Set of all branches (lines), $(i,j)$ denotes branch from node $i$ to $j$
    \item $\mathcal{L}_1$: Set of branches connected to substation (node 1)
    \item $\mathcal{B} \subseteq \mathcal{N}$: Set of nodes with batteries (energy storage)
    \item $\mathcal{D} \subseteq \mathcal{N}$: Set of nodes with solar PV (distributed energy resources)
    \item $\mathcal{T} = \{1, 2, \ldots, T\}$: Set of time periods (e.g., 24 hours, 96 15-min intervals)
    \item $t_0 \in \mathcal{T}$: Index for the control time of subproblem $t_0$
\end{itemize}

\textbf{Variable Color Coding:}
\begin{itemize}
    \item $\blueB{B_j^{t_0}[t]}$: Local SOC variables (blue) - battery $j$ in subproblem $t_0$, evaluated at time $t$
    \item $\redBhat{\hat{B}_j[t]}$: Global consensus SOC (red) - agreed-upon SOC for battery $j$ at time $t$
    \item $\greenu{u_j^{t_0}[t]}$: Scaled dual variables (green) - enforces consensus between local and global SOC
\end{itemize}

\subsection{Local Time Sets}

For each subproblem $t_0 \in \{1, 2, \ldots, T\}$, define the local time set:
\begin{align}
\mathcal{T}_{\text{local}}^{t_0} = \begin{cases}
\{1, 2\} & \text{if } t_0 = 1 \text{ (boundary)} \\
\{t_0-1, t_0, t_0+1\} & \text{if } 2 \leq t_0 \leq T-1 \text{ (interior)} \\
\{T-1, T\} & \text{if } t_0 = T \text{ (boundary)}
\end{cases}
\end{align}

\subsection{Step 1: Primal Update (Subproblem Optimization)}

For each subproblem $t_0 \in \{1, 2, \ldots, T\}$:

\begin{align}
\min_{\substack{P_{\text{Subs}}^{t_0}, Q_{\text{Subs}}^{t_0}, \\ P_{ij}^{t_0}, Q_{ij}^{t_0}, v_j^{t_0}, \ell_{ij}^{t_0}, \\ q_{D,j}^{t_0}, P_{B,j}^t, \blueB{B_j^{t_0}[t]} \\ \forall (i,j) \in \mathcal{L}, \, j \in \mathcal{N} \cup \mathcal{D} \cup \mathcal{B}, \\ t \in \mathcal{T}_{\text{local}}^{t_0}}} \quad & c^{t_0} \cdot P_{\text{Subs}}^{t_0} \cdot P_{\text{BASE}} \cdot \Delta t + C_B \sum_{j \in \mathcal{B}} \left(P_{B,j}^{t_0}\right)^2 \cdot P_{\text{BASE}}^2 \cdot \Delta t \notag \\
& + \frac{\rho}{2} \sum_{j \in \mathcal{B}} \sum_{t \in \mathcal{T}_{\text{local}}^{t_0}} \left( \blueB{B_j^{t_0}[t]} - \redBhat{\hat{B}_j[t]} + \greenu{u_j^{t_0}[t]} \right)^2 \label{eq:obj}
\end{align}

\textbf{Subject to:}

\textbf{Spatial Network Constraints (LinDistFlow SOCP, only for control time $t_0$):}
\begin{align}
\text{Power balance (substation):} \quad & P_{\text{Subs}}^{t_0} - \sum_{(1,j) \in \mathcal{L}_1} P_{1j}^{t_0} = 0 \label{eq:pbal_sub}\\
& Q_{\text{Subs}}^{t_0} - \sum_{(1,j) \in \mathcal{L}_1} Q_{1j}^{t_0} = 0 \label{eq:qbal_sub}\\
\text{Power balance (nodes):} \quad & P_{ij}^{t_0} - \sum_{(j,k) \in \mathcal{L}} P_{jk}^{t_0} = P_{B,j}^{t_0} + p_{D,j}^{t_0} - p_{L,j}^{t_0}, \quad \forall (i,j) \in \mathcal{L} \label{eq:pbal_node}\\
& Q_{ij}^{t_0} - \sum_{(j,k) \in \mathcal{L}} Q_{jk}^{t_0} = q_{D,j}^{t_0} - q_{L,j}^{t_0}, \quad \forall (i,j) \in \mathcal{L} \label{eq:qbal_node}\\
\text{KVL (voltage drop):} \quad & v_j^{t_0} = v_i^{t_0} - 2(r_{ij} P_{ij}^{t_0} + x_{ij} Q_{ij}^{t_0}) + \ell_{ij}^{t_0}, \quad \forall (i,j) \in \mathcal{L} \label{eq:kvl}\\
\text{SOCP relaxation:} \quad & \ell_{ij}^{t_0} \cdot v_i^{t_0} \geq (P_{ij}^{t_0})^2 + (Q_{ij}^{t_0})^2, \quad \forall (i,j) \in \mathcal{L} \label{eq:socp}\\
\text{Voltage limits:} \quad & (V_{\min,j})^2 \leq v_j^{t_0} \leq (V_{\max,j})^2, \quad \forall j \in \mathcal{N} \label{eq:vlim}\\
\text{Substation voltage:} \quad & v_1^{t_0} = (V_{\text{nom}})^2 \label{eq:vsub}\\
\text{PV reactive limits:} \quad & (q_{D,j}^{t_0})^2 \leq (S_{D,j})^2 - (p_{D,j}^{t_0})^2, \quad \forall j \in \mathcal{D} \label{eq:pvq}
\end{align}

\textit{Note:} Network variables $(P_{\text{Subs}}^{t_0}, Q_{\text{Subs}}^{t_0}, P_{ij}^{t_0}, Q_{ij}^{t_0}, v_j^{t_0}, \ell_{ij}^{t_0}, q_{D,j}^{t_0})$ are optimized only for the control time $t_0$, not for neighbor times.

\textbf{Temporal Battery Constraints:}

\noindent\textbf{Case 1: First time period ($t_0 = 1$):}

\textit{Local times: $\{1, 2\}$, Decision variables: $\blueB{B_j^{1}[1]}, \blueB{B_j^{1}[2]}$, Dual variables: $\greenu{u_j^{1}[1]}$ only}
\begin{align}
\text{SOC trajectory } t=0 \to t=1: \quad & \blueB{B_j^{1}[1]} = B_{0,j} - P_{B,j}^1 \cdot \Delta t, \quad \forall j \in \mathcal{B} \\
\text{SOC trajectory } t=1 \to t=2: \quad & \blueB{B_j^{1}[2]} = \blueB{B_j^{1}[1]} - P_{B,j}^2 \cdot \Delta t, \quad \forall j \in \mathcal{B}
\end{align}

\textit{Note:} $B_{0,j}$ is a parameter (initial condition), not a decision variable. Only $\blueB{B_j^{1}[1]}$ participates in consensus (with dual $\greenu{u_j^{1}[1]}$). Variable $\blueB{B_j^{1}[2]}$ exists for penalty computation but does not participate in consensus at $t=1$.

\noindent\textbf{Case 2: Interior time periods ($2 \leq t_0 \leq T-1$):}

\textit{Local times: $\{t_0-1, t_0, t_0+1\}$, Decision variables: $\blueB{B_j^{t_0}[t_0-1]}, \blueB{B_j^{t_0}[t_0]}, \blueB{B_j^{t_0}[t_0+1]}$}

\textit{Dual variables: $\greenu{u_j^{t_0}[t_0]}$ only}
\begin{align}
\text{SOC trajectory } t_0-1 \to t_0: \quad & \blueB{B_j^{t_0}[t_0]} = \blueB{B_j^{t_0}[t_0-1]} - P_{B,j}^{t_0} \cdot \Delta t, \quad \forall j \in \mathcal{B} \\
\text{SOC trajectory } t_0 \to t_0+1: \quad & \blueB{B_j^{t_0}[t_0+1]} = \blueB{B_j^{t_0}[t_0]} - P_{B,j}^{t_0+1} \cdot \Delta t, \quad \forall j \in \mathcal{B}
\end{align}

\textit{Note:} Only $\blueB{B_j^{t_0}[t_0]}$ participates in consensus update at time $t_0$ (with dual $\greenu{u_j^{t_0}[t_0]}$). Variables $\blueB{B_j^{t_0}[t_0-1]}$ and $\blueB{B_j^{t_0}[t_0+1]}$ are used for penalty terms but do not generate new dual variables in this subproblem.

\noindent\textbf{Case 3: Last time period ($t_0 = T$):}

\textit{Local times: $\{T-1, T\}$, Decision variables: $\blueB{B_j^{T}[T-1]}, \blueB{B_j^{T}[T]}$, Dual variables: $\greenu{u_j^{T}[T]}$ only}
\begin{align}
\text{SOC trajectory } T-1 \to T: \quad & \blueB{B_j^{T}[T]} = \blueB{B_j^{T}[T-1]} - P_{B,j}^T \cdot \Delta t, \quad \forall j \in \mathcal{B}
\end{align}

\textit{Note:} Only $\blueB{B_j^{T}[T]}$ participates in consensus at $t=T$ (with dual $\greenu{u_j^{T}[T]}$). Variable $\blueB{B_j^{T}[T-1]}$ is for penalty only.

\textbf{SOC and Power Limits:}
\begin{align}
\text{SOC limits:} \quad & \text{SOC}_{\min,j} \cdot B_{\text{rated},j} \leq \blueB{B_j^{t_0}[t]} \leq \text{SOC}_{\max,j} \cdot B_{\text{rated},j}, \notag \\
& \quad \forall t \in \mathcal{T}_{\text{local}}^{t_0}, \, j \in \mathcal{B} \\
\text{Power limits:} \quad & -P_{B,\text{rated},j} \leq P_{B,j}^{t} \leq P_{B,\text{rated},j}, \quad \forall t \in \mathcal{T}_{\text{local}}^{t_0}, \, j \in \mathcal{B}
\end{align}

\textit{Note:} Power limits must be enforced for \textit{all} times appearing in constraints, not just $t_0$. For interior times: $P_{B,j}^{t_0-1}, P_{B,j}^{t_0}, P_{B,j}^{t_0+1}$ all need limits.

\subsection{Step 2: Consensus Update (Local Averaging)}

For each battery $j \in \mathcal{B}$ and each time $t \in \mathcal{T}$, average only over subproblems where $t$ is the \textit{active} time:

\noindent\textbf{Consensus at $t=1$:}
\begin{align}
\redBhat{\hat{B}_j[1]} &= \text{clamp}\left( \frac{1}{2} \left( \blueB{B_j^{1}[1]} + \greenu{u_j^{1}[1]} + \blueB{B_j^{2}[1]} + \greenu{u_j^{2}[1]} \right), \underline{B}_j, \overline{B}_j \right)
\end{align}
\textit{Contributors:} Subproblems $t_0=1$ and $t_0=2$ (only these have $t=1$ as decision variable with dual)

\noindent\textbf{Consensus at interior times ($2 \leq t \leq T-1$):}
\begin{align}
\redBhat{\hat{B}_j[t]} &= \text{clamp}\left( \frac{1}{3} \left( \blueB{B_j^{t-1}[t]} + \greenu{u_j^{t-1}[t]} + \blueB{B_j^{t}[t]} + \greenu{u_j^{t}[t]} + \blueB{B_j^{t+1}[t]} + \greenu{u_j^{t+1}[t]} \right), \underline{B}_j, \overline{B}_j \right)
\end{align}
\textit{Contributors:} Subproblems $t_0 \in \{t-1, t, t+1\}$ (each has $t$ as its active control time)

\noindent\textbf{Consensus at $t=T$:}
\begin{align}
\redBhat{\hat{B}_j[T]} &= \text{clamp}\left( \frac{1}{2} \left( \blueB{B_j^{T-1}[T]} + \greenu{u_j^{T-1}[T]} + \blueB{B_j^{T}[T]} + \greenu{u_j^{T}[T]} \right), \underline{B}_j, \overline{B}_j \right)
\end{align}
\textit{Contributors:} Subproblems $t_0=T-1$ and $t_0=T$ (only these have $t=T$ as decision variable with dual)

\textbf{General form:}
\begin{align}
\mathcal{N}_t &= \{t_0 \in \mathcal{T} : t \text{ is the active control time in subproblem } t_0\} \\
&= \begin{cases}
\{1, 2\} & \text{if } t = 1 \\
\{t-1, t, t+1\} & \text{if } 2 \leq t \leq T-1 \\
\{T-1, T\} & \text{if } t = T
\end{cases}
\end{align}

\subsection{Step 3: Dual Update (All Local Times)}

For each subproblem $t_0 \in \mathcal{T}$ and battery $j \in \mathcal{B}$, update dual variables for \textbf{all local times} $t \in \mathcal{T}_{\text{local}}^{t_0}$:

\noindent\textbf{Subproblem $t_0=1$ (local times: $\{1, 2\}$):}
\begin{align}
\greenu{u_j^{1}[1]} &:= \greenu{u_j^{1}[1]} + \left( \blueB{B_j^{1}[1]} - \redBhat{\hat{B}_j[1]} \right) \\
\greenu{u_j^{1}[2]} &:= \greenu{u_j^{1}[2]} + \left( \blueB{B_j^{1}[2]} - \redBhat{\hat{B}_j[2]} \right)
\end{align}

\noindent\textbf{Subproblem $t_0$ ($2 \leq t_0 \leq T-1$, local times: $\{t_0-1, t_0, t_0+1\}$):}
\begin{align}
\greenu{u_j^{t_0}[t_0-1]} &:= \greenu{u_j^{t_0}[t_0-1]} + \left( \blueB{B_j^{t_0}[t_0-1]} - \redBhat{\hat{B}_j[t_0-1]} \right) \\
\greenu{u_j^{t_0}[t_0]} &:= \greenu{u_j^{t_0}[t_0]} + \left( \blueB{B_j^{t_0}[t_0]} - \redBhat{\hat{B}_j[t_0]} \right) \\
\greenu{u_j^{t_0}[t_0+1]} &:= \greenu{u_j^{t_0}[t_0+1]} + \left( \blueB{B_j^{t_0}[t_0+1]} - \redBhat{\hat{B}_j[t_0+1]} \right)
\end{align}

\noindent\textbf{Subproblem $t_0=T$ (local times: $\{T-1, T\}$):}
\begin{align}
\greenu{u_j^{T}[T-1]} &:= \greenu{u_j^{T}[T-1]} + \left( \blueB{B_j^{T}[T-1]} - \redBhat{\hat{B}_j[T-1]} \right) \\
\greenu{u_j^{T}[T]} &:= \greenu{u_j^{T}[T]} + \left( \blueB{B_j^{T}[T]} - \redBhat{\hat{B}_j[T]} \right)
\end{align}

\textbf{General Form:}
\begin{align}
\text{For each } t \in \mathcal{T}_{\text{local}}^{t_0}: \quad \greenu{u_j^{t_0}[t]} &:= \greenu{u_j^{t_0}[t]} + \left( \blueB{B_j^{t_0}[t]} - \redBhat{\hat{B}_j[t]} \right)
\end{align}

\textbf{Critical Note:} Each subproblem $t_0$ maintains dual variables for \textit{all} its local times $\mathcal{T}_{\text{local}}^{t_0}$, which is 2 or 3 times per battery. This ensures that each time $t$ has duals from all subproblems that include it in their penalty terms, enabling proper consensus averaging in Step 2.

\subsection{Convergence Criteria (Exact Implementation)}

\textbf{Primal Residual (Consensus Violation):}

Only count residuals at active control times (where dual variables exist):
\begin{align}
r_{\text{values}} &= \left\{ \blueB{B_j^{t_0,k}[t_0]} - \redBhat{\hat{B}_j^k[t_0]} : t_0 \in \mathcal{T}, \, j \in \mathcal{B} \right\} \\
\|r^k\|_2 &= \frac{\|\mathbf{r}_{\text{values}}\|_2}{\sqrt{|\mathbf{r}_{\text{values}}|}} = \frac{1}{\sqrt{T \cdot |\mathcal{B}|}} \left( \sum_{t_0=1}^T \sum_{j \in \mathcal{B}} \left( \blueB{B_j^{t_0,k}[t_0]} - \redBhat{\hat{B}_j^k[t_0]} \right)^2 \right)^{1/2}
\end{align}

\textit{Note:} We only compute residual at time $t_0$ for each subproblem $t_0$ (the active control time where dual $\greenu{u_j^{t_0}[t_0]}$ exists). The normalization is by $\sqrt{T \cdot |\mathcal{B}|}$, the number of active consensus variables.

\textbf{Dual Residual (Consensus Variable Change):}

Measures how much the consensus variables $\redBhat{\hat{B}}$ changed from previous iteration:
\begin{align}
\mathbf{s}_j^k &= \redBhat{\hat{B}_j^k} - \redBhat{\hat{B}_j^{k-1}} = \begin{bmatrix} \redBhat{\hat{B}_j^k[1]} - \redBhat{\hat{B}_j^{k-1}[1]} \\ \vdots \\ \redBhat{\hat{B}_j^k[T]} - \redBhat{\hat{B}_j^{k-1}[T]} \end{bmatrix} \quad \in \mathbb{R}^T \\
\|s^k\|_2 &= \frac{\rho^k}{|\mathcal{B}|} \left\| \begin{bmatrix} \mathbf{s}_1^k \\ \vdots \\ \mathbf{s}_{|\mathcal{B}|}^k \end{bmatrix} \right\|_2 = \frac{\rho^k}{|\mathcal{B}|} \left( \sum_{j \in \mathcal{B}} \sum_{t=1}^T \left( \redBhat{\hat{B}_j^k[t]} - \redBhat{\hat{B}_j^{k-1}[t]} \right)^2 \right)^{1/2}
\end{align}

\textit{Note:} The dual residual is scaled by $\rho$ and normalized by $|\mathcal{B}|$ (number of batteries), not by $\sqrt{T \cdot |\mathcal{B}|}$.

\textbf{Convergence Condition:}
\begin{align}
\text{Converged if } \|r^k\|_2 \leq \epsilon_{\text{pri}} \quad \text{and} \quad \|s^k\|_2 \leq \epsilon_{\text{dual}}
\end{align}

with $\epsilon_{\text{pri}} = 10^{-5}$ and $\epsilon_{\text{dual}} = 10^{-4}$.

\subsection{Complexity Comparison}

\begin{center}
\begin{tabular}{lcc}
\toprule
\textbf{Metric} & \textbf{Global Coupling} & \textbf{Local Coupling} \\
\midrule
SOC variables per subproblem & $T \times |\mathcal{B}|$ & $2$ or $3 \times |\mathcal{B}|$ \\
Dual variables per subproblem & $T \times |\mathcal{B}|$ & $2$ or $3 \times |\mathcal{B}|$ (same as SOC) \\
Penalty terms per subproblem & $T \times |\mathcal{B}|$ & $2$ or $3 \times |\mathcal{B}|$ \\
Total SOC storage & $T^2 \times |\mathcal{B}|$ & $(2 \cdot 2 + 3 \cdot (T-2)) \times |\mathcal{B}| = (3T-2) \times |\mathcal{B}|$ \\
Total dual storage & $T^2 \times |\mathcal{B}|$ & $(3T-2) \times |\mathcal{B}|$ (same as SOC) \\
Communication per iteration & $T \times |\mathcal{B}|$ per subproblem & $2$ or $3 \times |\mathcal{B}|$ per subproblem \\
Consensus contributors per time & All $T$ subproblems & Only $2$ or $3$ neighbors \\
\bottomrule
\end{tabular}
\end{center}

\textbf{For $T=24$, $|\mathcal{B}|=26$ batteries:}
\begin{itemize}
    \item \textbf{SOC Variables:}
    \begin{itemize}
        \item Global: $24^2 \times 26 = 14,976$ total
        \item Local: $(3 \times 24 - 2) \times 26 = 1,872$ total
        \item \textbf{Reduction: $8.0\times$}
    \end{itemize}
    \item \textbf{Dual Variables:}
    \begin{itemize}
        \item Global: $24^2 \times 26 = 14,976$ total
        \item Local: $24 \times 26 = 624$ total
        \item \textbf{Reduction: $24\times$}
    \end{itemize}
    \item \textbf{Per-subproblem SOC variables:}
    \begin{itemize}
        \item Global: $24 \times 26 = 624$ per subproblem
        \item Local (boundary): $2 \times 26 = 52$ per subproblem
        \item Local (interior): $3 \times 26 = 78$ per subproblem
        \item \textbf{Reduction: $12\times$ (boundary), $8\times$ (interior)}
    \end{itemize}
\end{itemize}

\clearpage

\section{Adaptive Penalty Parameter: Two-Phase Strategy with Watchdog}

The penalty parameter $\rho$ is adjusted dynamically using a sophisticated two-phase strategy that prioritizes primal convergence initially, then balances both residuals. The scheme is activated by setting \texttt{adaptive\_rho = true}.

\subsection{Residual Calculations (Exact Implementation)}

\textbf{Primal Residual (Consensus Violation):}
\begin{align}
\|r^k\|_2 &= \frac{1}{\sqrt{N_{\text{active}}}} \left( \sum_{t_0=1}^T \sum_{j \in \mathcal{B}} \left( \blueB{B_j^{t_0,k}[t_0]} - \redBhat{\hat{B}_j^k[t_0]} \right)^2 \right)^{1/2}
\end{align}
where $N_{\text{active}} = T \times |\mathcal{B}|$ is the number of active time-battery pairs (only counting where duals exist).

\textbf{Dual Residual (Consensus Variable Change):}
\begin{align}
\|s^k\|_2 &= \frac{\rho^k}{|\mathcal{B}|} \left( \sum_{j \in \mathcal{B}} \sum_{t=1}^T \left( \redBhat{\hat{B}_j^k[t]} - \redBhat{\hat{B}_j^{k-1}[t]} \right)^2 \right)^{1/2}
\end{align}

\subsection{Phase 1: Aggressive Primal Convergence (Until $\|r\| \leq \epsilon_{\text{pri}}$)}

\textbf{Objective:} Drive primal residual below threshold by only increasing $\rho$. Never decrease $\rho$ to avoid slowing consensus formation.

\textbf{Update Rules (every $N_{\text{update}} = 5$ iterations):}
\begin{align}
\rho^{k+1} &= \begin{cases}
\min(\rho_{\max}, \tau_{\text{incr}} \cdot \rho^k) & \text{if } \|r^k\| > \mu \cdot \|s^k\| \\
\min(\rho_{\max}, \tau_{\text{nudge}} \cdot \rho^k) & \text{if } \|r^k\| > \epsilon_{\text{pri}} \text{ and no $\rho$ change for } N_{\text{stall}} \text{ iters} \\
\rho^k & \text{otherwise (do not decrease)}
\end{cases}
\end{align}

\textbf{Phase Transition:}
\begin{align}
\text{Switch to Phase 2 if } \|r^k\| \leq \epsilon_{\text{pri}} \text{ (primal converged once)}
\end{align}

\subsection{Phase 2: Bidirectional Adaptation (After primal convergence)}

\textbf{Objective:} Balance primal and dual residuals, allowing both increases and decreases of $\rho$.

\textbf{Update Rules (every $N_{\text{update}} = 5$ iterations):}
\begin{align}
\rho^{k+1} &= \begin{cases}
\min(\rho_{\max}, \tau_{\text{incr}} \cdot \rho^k) & \text{if } \|r^k\| > \mu \cdot \|s^k\| \\
\max(\rho_{\min}, \rho^k / \tau_{\text{decr}}) & \text{if } \|s^k\| > \mu \cdot \|r^k\| \textbf{ and } \|r^k\| \leq \epsilon_{\text{pri}} \\
\rho^k & \text{otherwise (residuals balanced)}
\end{cases}
\end{align}

\textbf{Watchdog Protection:} The decrease condition includes $\|r^k\| \leq \epsilon_{\text{pri}}$ to prevent premature decreases when primal consensus breaks down after Phase 1 → 2 transition.

\subsection{Primal Residual Watchdog (All Phases)}

\textbf{Motivation:} Detects when primal residual stays elevated for many consecutive iterations, indicating insufficient penalty to enforce consensus.

\textbf{Hysteresis-Based Counter (runs every iteration):}
\begin{align}
\text{counter}^{k+1} &= \begin{cases}
\text{counter}^k + 1 & \text{if } \|r^k\| > 2\epsilon_{\text{pri}} \\
0 & \text{if } \|r^k\| < 0.5\epsilon_{\text{pri}} \\
\text{counter}^k & \text{if } 0.5\epsilon_{\text{pri}} \leq \|r^k\| \leq 2\epsilon_{\text{pri}} \text{ (hysteresis zone)}
\end{cases}
\end{align}

\textbf{Watchdog Trigger:}
\begin{align}
\text{If counter}^k \geq N_{\text{watchdog}} = 20: \quad \rho^{k+1} &= \min(\rho_{\max}, \tau_{\text{watchdog}} \cdot \rho^k), \quad \text{counter}^{k+1} = 0
\end{align}

The hysteresis prevents false resets from oscillations around $\epsilon_{\text{pri}}$, while the 20-iteration window ensures sustained high residuals trigger aggressive action.

\subsection{Dual Variable Rescaling}

When $\rho$ changes from $\rho^k$ to $\rho^{k+1}$, the scaled dual variables must be rescaled:
\begin{align}
\greenu{u_j^{t_0}[t]} &\leftarrow \greenu{u_j^{t_0}[t]} \cdot \frac{\rho^k}{\rho^{k+1}}, \quad \forall t_0 \in \mathcal{T}, \, j \in \mathcal{B}, \, t \in \mathcal{T}_{\text{local}}^{t_0}
\end{align}

This maintains the relationship between scaled and unscaled dual variables: $\greenu{u} = \lambda / \rho$.

\subsection{Complete Parameter Summary}

\begin{center}
\begin{tabular}{ll}
\toprule
\textbf{Parameter} & \textbf{Value (SOCP tADMM)} \\
\midrule
\textbf{Tolerances} & \\
Primal tolerance $\epsilon_{\text{pri}}$ & $1 \times 10^{-5}$ \\
Dual tolerance $\epsilon_{\text{dual}}$ & $1 \times 10^{-4}$ (relaxed for faster convergence) \\
\midrule
\textbf{Standard Adaptive Parameters} & \\
Balance factor $\mu$ & $5.0$ \\
Increase factor $\tau_{\text{incr}}$ & $2.0$ (double $\rho$) \\
Decrease factor $\tau_{\text{decr}}$ & $2.0$ (halve $\rho$) \\
Update interval $N_{\text{update}}$ & $5$ iterations \\
\midrule
\textbf{Bounds} & \\
Minimum $\rho_{\min}$ & $1.0$ \\
Maximum $\rho_{\max}$ & $10^6$ \\
\midrule
\textbf{Phase 1 Nudge (Stall Detection)} & \\
Stall check interval $N_{\text{stall}}$ & $5$ iterations \\
Stall nudge factor $\tau_{\text{nudge}}$ & $2.0$ \\
Enable stall detection & \texttt{false} (disabled for clean testing) \\
\midrule
\textbf{Watchdog Parameters} & \\
Enable watchdog & \texttt{true} \\
Watchdog window $N_{\text{watchdog}}$ & $20$ iterations \\
Watchdog factor $\tau_{\text{watchdog}}$ & $2.0$ (double $\rho$) \\
Upper threshold (increment counter) & $2\epsilon_{\text{pri}} = 2 \times 10^{-5}$ \\
Lower threshold (reset counter) & $0.5\epsilon_{\text{pri}} = 5 \times 10^{-6}$ \\
\midrule
\textbf{Disabled Features} & \\
Stability zone (freeze $\rho$ near convergence) & \texttt{false} \\
Slow progress acceleration & \texttt{false} \\
\bottomrule
\end{tabular}
\end{center}

\subsection{Convergence Impact}

For LinDistFlow SOCP problems (ieee123A\_1ph, T=96, 26 batteries):
\begin{itemize}
    \item \textbf{Phase 1}: $\rho$ increases rapidly ($40000 \to 80000 \to 160000$) driving primal convergence
    \item \textbf{Phase 1→2 Transition}: At $k \approx 15$ when $\|r\| < 10^{-5}$
    \item \textbf{Phase 2}: Bidirectional adaptation, but decreases blocked by watchdog protection if $\|r\|$ rises
    \item \textbf{Watchdog}: Triggers every 20 iterations if primal residual stays elevated, preventing slow drift
    \item \textbf{Total Iterations}: Typically 100--200 iterations for tight tolerances with threading enabled
\end{itemize}

\clearpage

\section{Copper Plate Localized tADMM (Reduced Network)}

\subsection{Overview}

The copper plate formulation simplifies the multi-period OPF by removing network constraints entirely, reducing each time period's problem to pure energy arbitrage. Combined with localized temporal coupling (Section 1), this yields the most compact tADMM subproblems.

\textbf{Key Simplifications:}
\begin{itemize}
    \item \textbf{Network}: No voltage, power flow, or line constraints
    \item \textbf{Spatial}: Single aggregated load, single aggregated battery
    \item \textbf{Temporal}: Localized coupling (2--3 time steps per subproblem)
    \item \textbf{Problem Size}: Each subproblem has only 3--5 decision variables
\end{itemize}

\subsection{Local Time Sets (Copper Plate)}

Same as LinDistFlow localized formulation:
\begin{align}
\mathcal{T}_{\text{local}}^{t_0} = \begin{cases}
\{1, 2\} & \text{if } t_0 = 1 \\
\{t_0-1, t_0, t_0+1\} & \text{if } 2 \leq t_0 \leq T-1 \\
\{T-1, T\} & \text{if } t_0 = T
\end{cases}
\end{align}

\subsection{Primal Update (Copper Plate, Subproblem $t_0$)}

For each subproblem $t_0 \in \{1, 2, \ldots, T\}$:

\begin{align}
\min_{\substack{P_{\text{subs}}^{t_0}, P_B^t, \blueB{B^{t_0}[t]} \\ t \in \mathcal{T}_{\text{local}}^{t_0}}} \quad & c^{t_0} \cdot P_{\text{subs}}^{t_0} \cdot P_{\text{BASE}} \cdot \Delta t + C_B \cdot \left(P_B^{t_0}\right)^2 \cdot P_{\text{BASE}}^2 \cdot \Delta t \notag \\
& + \frac{\rho}{2} \sum_{t \in \mathcal{T}_{\text{local}}^{t_0}} \left( \blueB{B^{t_0}[t]} - \redBhat{\hat{B}[t]} + \greenu{u^{t_0}[t]} \right)^2
\end{align}

\textbf{Subject to:}

\textbf{Nodal Real Power Balance (only at $t_0$):}
\begin{align}
P_{\text{subs}}^{t_0} + P_B^{t_0} = P_L^{t_0}
\end{align}

\textbf{Battery SOC Dynamics:}

\noindent\textbf{Case 1: $t_0 = 1$ (First period):}

\textit{Local times: $\{1, 2\}$, Optimize: $\blueB{B^{1}[1]}, \blueB{B^{1}[2]}, P_B^1, P_B^2, P_{\text{subs}}^1$}
\begin{align}
\blueB{B^{1}[1]} &= B_0 - P_B^1 \cdot \Delta t \\
\blueB{B^{1}[2]} &= \blueB{B^{1}[1]} - P_B^2 \cdot \Delta t
\end{align}

\noindent\textbf{Case 2: $2 \leq t_0 \leq T-1$ (Interior periods):}

\textit{Local times: $\{t_0-1, t_0, t_0+1\}$, Optimize: $\blueB{B^{t_0}[t_0-1]}, \blueB{B^{t_0}[t_0]}, \blueB{B^{t_0}[t_0+1]}, P_B^{t_0}, P_B^{t_0+1}, P_{\text{subs}}^{t_0}$}
\begin{align}
\blueB{B^{t_0}[t_0]} &= \blueB{B^{t_0}[t_0-1]} - P_B^{t_0} \cdot \Delta t \\
\blueB{B^{t_0}[t_0+1]} &= \blueB{B^{t_0}[t_0]} - P_B^{t_0+1} \cdot \Delta t
\end{align}

\noindent\textbf{Case 3: $t_0 = T$ (Last period):}

\textit{Local times: $\{T-1, T\}$, Optimize: $\blueB{B^{T}[T-1]}, \blueB{B^{T}[T]}, P_B^T, P_{\text{subs}}^T$}
\begin{align}
\blueB{B^{T}[T]} &= \blueB{B^{T}[T-1]} - P_B^T \cdot \Delta t
\end{align}

\textbf{Battery Bounds (all local times):}
\begin{align}
\underline{B} &\leq \blueB{B^{t_0}[t]} \leq \overline{B}, \quad \forall t \in \mathcal{T}_{\text{local}}^{t_0} \\
-P_{B,R} &\leq P_B^t \leq P_{B,R}, \quad \forall t \in \{t_0, t_0+1\} \cap \mathcal{T}_{\text{local}}^{t_0}
\end{align}

\subsection{Consensus Update (Localized Averaging)}

For each time step $t \in \{1, 2, \ldots, T\}$, average over subproblems containing $t$:

\begin{align}
\redBhat{\hat{B}[t]} = \begin{cases}
\frac{1}{2} \left( \blueB{B^{1}[1]} + \greenu{u^{1}[1]} + \blueB{B^{2}[1]} + \greenu{u^{2}[1]} \right) & \text{if } t = 1 \\[0.5em]
\frac{1}{3} \sum_{t_0 \in \{t-1, t, t+1\}} \left( \blueB{B^{t_0}[t]} + \greenu{u^{t_0}[t]} \right) & \text{if } 2 \leq t \leq T-1 \\[0.5em]
\frac{1}{2} \left( \blueB{B^{T-1}[T]} + \greenu{u^{T-1}[T]} + \blueB{B^{T}[T]} + \greenu{u^{T}[T]} \right) & \text{if } t = T
\end{cases}
\end{align}

\textbf{Projection onto Feasible Set:}
\begin{align}
\redBhat{\hat{B}[t]} &\leftarrow \max\left( \underline{B}, \min\left( \overline{B}, \redBhat{\hat{B}[t]} \right) \right)
\end{align}

\subsection{Dual Update (Localized)}

For each subproblem $t_0 \in \{1, 2, \ldots, T\}$ and $t \in \mathcal{T}_{\text{local}}^{t_0}$:
\begin{align}
\greenu{u^{t_0}[t]} &\leftarrow \greenu{u^{t_0}[t]} + \left( \blueB{B^{t_0}[t]} - \redBhat{\hat{B}[t]} \right)
\end{align}

\textbf{Number of Dual Updates per Iteration:}
\begin{itemize}
    \item Subproblem $t_0 = 1$: Update 2 dual variables ($\greenu{u^{1}[1]}, \greenu{u^{1}[2]}$)
    \item Subproblems $t_0 = 2, \ldots, T-1$: Update 3 dual variables each
    \item Subproblem $t_0 = T$: Update 2 dual variables ($\greenu{u^{T}[T-1]}, \greenu{u^{T}[T]}$)
    \item \textbf{Total}: $2 + 3(T-2) + 2 = 3T - 2$ dual variable updates
\end{itemize}

\subsection{Convergence Criteria}

\textbf{Primal Residual (consensus violation):}
\begin{align}
\|r^k\|_2 = \frac{1}{T} \sqrt{ \sum_{t_0=1}^T \sum_{t \in \mathcal{T}_{\text{local}}^{t_0}} \left( \blueB{B^{t_0}[t]} - \redBhat{\hat{B}[t]} \right)^2 }
\end{align}

\textbf{Dual Residual (consensus change):}
\begin{align}
\|s^k\|_2 = \frac{\rho}{T} \sqrt{ \sum_{t=1}^T \left( \redBhat{\hat{B}^k[t]} - \redBhat{\hat{B}^{k-1}[t]} \right)^2 }
\end{align}

\textbf{Stopping Criteria:}
\begin{align}
\text{Converged if: } \quad \|r^k\|_2 \leq \epsilon_{\text{pri}} \quad \text{and} \quad \|s^k\|_2 \leq \epsilon_{\text{dual}}
\end{align}

\subsection{Complexity Comparison}

\begin{table}[h]
\centering
\begin{tabular}{l c c c}
\toprule
\textbf{Formulation} & \textbf{Variables/Subproblem} & \textbf{Coupling Variables} & \textbf{Total Storage} \\
\midrule
Global tADMM & $T$ SOC + $T$ power & $T$ & $T^2$ \\
Localized tADMM (LinDistFlow) & 2--3 SOC + 2--3 power & 2--3 & $3T$ \\
\textbf{Localized Copper Plate} & \textbf{2--3 SOC + 1--2 power} & \textbf{2--3} & \textbf{3T} \\
\bottomrule
\end{tabular}
\caption{Comparison of tADMM formulations (per-unit battery system)}
\end{table}

\textbf{Copper Plate Advantages:}
\begin{itemize}
    \item \textbf{Minimal subproblem size}: 3--5 decision variables per subproblem
    \item \textbf{No spatial coupling}: Pure temporal decomposition
    \item \textbf{Fast solves}: Each subproblem is a small LP/QP ($<$1ms with Gurobi)
    \item \textbf{Scalability}: Computational cost grows linearly with $T$ (not $T^2$)
\end{itemize}

\subsection{Example: 24-Hour Copper Plate Problem}

\textbf{Problem Data:}
\begin{itemize}
    \item Time periods: $T = 24$ (hourly intervals)
    \item Battery: $E_{\text{rated}} = 4000$ kWh, $P_{B,R} = 800$ kW
    \item Load: $P_L \in [800, 1200]$ kW (time-varying)
    \item Energy price: $c^t \in [0.08, 0.20]$ \$/kWh (sinusoidal)
    \item Quadratic battery cost: $C_B = 10^{-6} \times \min(c^t)$
\end{itemize}

\textbf{Convergence Performance:}
\begin{itemize}
    \item \textbf{Fixed $\rho = 10.0$}: $\sim$200--300 iterations
    \item \textbf{Adaptive $\rho$ (Boyd)}: $\sim$98 iterations ($\rho$: $10.0 \to 5.0 \to 2.5 \to 1.25$)
    \item \textbf{Solve time}: $<$5 seconds total (single-threaded Julia)
    \item \textbf{Objective gap vs. centralized}: $<10^{-6}$ (numerically exact)
\end{itemize}

\clearpage

\section{Appendix: Full Variable and Parameter Definitions}

\subsection{System Bases}
\begin{align}
\text{kV}_B &= \frac{4.16}{\sqrt{3}} \text{ kV (phase-to-neutral)} \\
\text{kVA}_B &= 1000 \text{ kVA} \\
P_{\text{BASE}} &= 1000 \text{ kW} \\
E_{\text{BASE}} &= 1000 \text{ kWh per hour}
\end{align}

\subsection{SOC Bound Definitions}
\begin{align}
\underline{B} &= \text{SOC}_{\min} \cdot E_{\text{Rated}} \\
\overline{B} &= \text{SOC}_{\max} \cdot E_{\text{Rated}}
\end{align}

\subsection{Physical Interpretation}
\begin{itemize}
    \item $P_B[t] > 0$: Battery discharging (providing power to the system)
    \item $P_B[t] < 0$: Battery charging (consuming power from the system)
    \item $B[t]$: Battery state of charge at the end of period $t$
    \item $\underline{B} = \text{SOC}_{\min} \cdot E_{\text{Rated}}$: Lower SOC bound
    \item $\overline{B} = \text{SOC}_{\max} \cdot E_{\text{Rated}}$: Upper SOC bound
\end{itemize}

\end{document}